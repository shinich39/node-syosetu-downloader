import Q from"dayjs";import*as Y from"cheerio";import V from"puppeteer-extra";import wt from"puppeteer-extra-plugin-stealth";import{CookieJar as xt}from"tough-cookie";import $t from"fetch-cookie";function et(i){return typeof i=="boolean"}function A(i){return typeof i=="number"&&!Number.isNaN(i)&&Number.isFinite(i)}function B(i){return typeof i=="string"}function y(i){return typeof i=="object"&&i!==null&&!x(i)}function x(i){return Array&&Array.isArray?Array.isArray(i):Object.prototype.toString.call(i)==="[object Array]"}function rt(i){return typeof i=="function"}function Z(i,t,e){return i-=t,e-=t,i<0&&(i=i%e+e),i>=e&&(i=i%e),i+t}function C(i){return i.replace(/[！-～]/g,function(t){return String.fromCharCode(t.charCodeAt(0)-65248)}).replace(/[^\S\r\n]/g," ")}function nt(i){let t=i.split("/"),e=t.pop(),o=t.slice(1,t.length).join("/");return new RegExp(o,e)}function N(i){let t={};for(let[e,o]of Object.entries(i))y(o)?t[e]=N(o):x(o)?t[e]=G(o):t[e]=o;return t}function D(i,t){function e(a,r){if(y(r)){for(let[n,l]of Object.entries(r))if(!o(a,l,n.split(".")))return!1;return!0}else return s(a,r,"$eq")}function o(a,r,n){let l=n.shift();return n.length>0?y(a)&&B(l)?o(a[l],r,n):!1:B(l)?s(a,r,l):!1}function s(a,r,n){if(n==="$and"){if(!x(r))throw new Error(`Invalid query type: ${typeof r}`);for(let l of r)if(!e(a,l))return!1;return!0}else{if(n==="$nand")return!s(a,r,"$and");if(n==="$or"){if(!x(r))throw new Error(`Invalid query type: ${typeof r}`);for(let l of r)if(e(a,l))return!0;return!1}else{if(n==="$nor")return!s(a,r,"$or");if(n==="$not")return!e(a,r);if(n==="$in"){if(!x(r))throw new Error(`Invalid query type: ${typeof r}`);for(let l of r)if(s(a,l,"$eq"))return!0;return!1}else{if(n==="$nin")return!s(a,r,"$in");if(n==="$gt"){if(!A(r))throw new Error(`Invalid query type: ${typeof r}`);return a>r}else if(n==="$gte"){if(!A(r))throw new Error(`Invalid query type: ${typeof r}`);return a>=r}else if(n==="$lt"){if(!A(r))throw new Error(`Invalid query type: ${typeof r}`);return a<r}else if(n==="$lte"){if(!A(r))throw new Error(`Invalid query type: ${typeof r}`);return a<=r}else if(n==="$eq")if(x(a)&&x(r)){if(a.length!==r.length)return!1;for(let l in r)if(!s(a[l],r[l],"$eq"))return!1;return!0}else return y(r)?e(a,r):a===r;else{if(n==="$ne")return!s(a,r,"$eq");if(n==="$exists"){if(!et(r))throw new Error(`Invalid query type: ${typeof r}`);return a!=null===r}else if(n==="$elemMatch"){if(!y(r))throw new Error(`Invalid query type: ${typeof r}`);if(!x(a))return!1;for(let l of a)if(!e(l,r))return!1;return!0}else if(n==="$mod"){if(!x(r))throw new Error(`Invalid query type: ${typeof r}`);let l=r[0],u=r[1];if(!A(l))throw new Error(`Invalid divisor type: ${typeof l}`);if(!A(u))throw new Error(`Invalid remainder type: ${typeof u}`);return a%l===u}else{if(n==="$size")return x(a)?e(a.length,r):y(a)?e(Object.keys(a).length,r):!1;if(n==="$function"){if(!rt(r))throw new Error(`Invalid query type: ${typeof r}`);return r(a)}else if(n==="$regex"){if(B(r))return r.charAt(0)==="/"?nt(r).test(a):new RegExp(r).test(a);if(r instanceof RegExp)return r.test(a);throw new Error(`Invalid query type: ${typeof r}`)}else if(/^\$-?[0-9]+$/.test(n)){let l=Math.floor(Z(parseInt(n.substring(1)),0,a.length));return e(a[l],r)}else return y(a)?y(r)?e(a[n],r):s(a[n],r,"$eq"):!1}}}}}}return e(i,t)}function ot(i,t){for(let e of Object.keys(t))for(let[o,s]of Object.entries(t[e])){let a=o.split("."),r=a.pop();if(!B(r))continue;let n=i;for(;y(n);){let l=a.shift();if(!l)break;n=n[l]}if(y(n)){if(e==="$set")n[r]=s;else if(e==="$unset")s&&delete n[r];else if(e==="$push")n[r].push(s);else if(e==="$pushAll"){if(Array.isArray(s))for(let l of s)n[r].push(l)}else if(e==="$pull"){for(let l=n[r].length;l>=0;l--)if(n[r][l]===s){n[r].splice(l,1);break}}else if(e==="$pullAll")Array.isArray(s)&&(n[r]=n[r].filter(function(l){for(let u of s)if(l===u)return!1;return!0}));else if(e==="$addToSet"){let l=!1;for(let u of n[r])if(u===s){l=!0;break}l||n[r].push(s)}else if(e==="$addToSetAll"&&Array.isArray(s))for(let l of s){let u=!1;for(let f of n[r])if(f===l){u=!0;break}u||n[r].push(l)}}}return i}function G(i){let t=[];for(let e=0;e<i.length;e++){let o=i[e];y(o)?i[e]=N(o):x(o)?i[e]=G(o):i[e]=o}return t}function v(i){return new Promise(function(t){return setTimeout(t,i)})}var I=[["&","&amp;"],[" ","&nbsp;"],["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&apos;"],["\xA2","&cent;"],["\xA3","&pound;"],["\xA5","&yen;"],["\u20AC","&euro;"],["\xA9","&copy;"],["\xAE","&reg;"]],k=[["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&apos;"]];function it(i){return i.replace(/\r\n/g,`
`)}function st(i){return i.replace(/^</,"").replace(/([^<][!?/])?>$/,"").replace(/\s+/g," ").trim()}function at(i,t){for(let e=i.length-1;e>=0;e--)if(t(i[e],e,i))return e;return-1}function j(i){return encodeURIComponent(i)}function W(i){return decodeURIComponent(i)}function lt(i){for(let t=0;t<I.length;t++)i=i.replace(new RegExp(I[t][0],"g"),I[t][1]);return i}function F(i){for(let t=I.length-1;t>=0;t--)i=i.replace(new RegExp(I[t][1],"g"),I[t][0]);return i}function ut(i){for(let t=0;t<k.length;t++)i=i.replace(new RegExp(k[t][0],"g"),k[t][1]);return i}function ct(i){return i.replace(/<!--([\s\S]*?)-->/g,function(...t){return`<!-->${j(t[1])}</!-->`})}function ft(i){return i.replace(/(<script(?:[\s\S]*?)>)([\s\S]*?)(<\/script>)/g,function(...t){return`${t[1]}${j(t[2])}${t[3]}`})}function ht(i){return i.replace(/(<style(?:[\s\S]*?)>)([\s\S]*?)(<\/style>)/g,function(...t){return`${t[1]}${j(t[2])}${t[3]}`})}function pt(i){return i.replace(/(>)([\s\S]*?)(<)/g,function(...t){return`${t[1]}${lt(t[2])}${t[3]}`})}function gt(i){function t(...e){return`=${j(e[1])} `}return i.replace(/='([^'>]*?)'/g,t).replace(/="([^">]*?)"/g,t)}function dt(i,t){let e=t.split("="),o=e.shift();o&&(e.length===0?i[o]=!0:i[o]=W(e.join("=")))}function mt(i){let t=st(i).split(/\s/),e={tag:t[0]||"",attributes:{},children:[],isClosing:!1,isClosed:!1,isEncoded:!1};typeof e.tag=="string"&&(e.isClosing=/^\//.test(e.tag),e.isClosed=e.isClosing,e.tag=e.tag.replace(/^\//,""),!e.isClosing&&["script","style","!--"].indexOf(e.tag)>-1&&(e.isEncoded=!0));for(let o=1;o<t.length;o++)dt(e.attributes,t[o]);return e}function yt(i){let t="";for(let[e,o]of Object.entries(i))typeof o=="string"?t+=` ${e}="${ut(o)}"`:o===!0&&(t+=` ${e}`);return t}function z(i){i=gt(pt(ht(ft(ct(it(i))))));let t=0,e=/<[^>]*?>/g,o,s=[],a=[],r;for(;o=e.exec(i);){if(t!==o.index){let n=i.substring(t,o.index);s.push({content:F(n)})}if(r=mt(o[0]),!r.isClosing)s.push(r),a.push(r);else{let n=at(s,function(l){return!l.isClosed&&l.tag===r.tag});if(n>-1){let l=s[n];l.isClosed=!0,l.children=s.splice(n+1,s.length-n+1)}}t=e.lastIndex}if(t<i.length){let n=i.substring(t);s.push({content:F(n)})}for(let n of a){if(n.tag&&(n.tag.toUpperCase()==="!DOCTYPE"?n.closer="":n.tag.toLowerCase()==="?xml"?n.closer="?":n.tag==="!--"?n.closer="--":n.isClosed||(n.closer=" /"),n.isEncoded&&n.children))for(let l of n.children)l.content&&(l.content=W(l.content));delete n.isClosed,delete n.isClosing,delete n.isEncoded}return{children:s}}function R(i,t){let e=0,o=function(s){let{tag:a,closer:r,attributes:n,content:l}=t?t(s,e):s,u="";if(e++,typeof a=="string"){if(u+=`<${a}`,typeof n=="object"&&(u+=yt(n)),typeof r!="string"&&(u+=">"),Array.isArray(s.children))for(let f of s.children)u+=o(f);typeof r!="string"?u+=`</${a}>`:u+=`${r}>`}else if(typeof l=="string")u=l;else if(Array.isArray(s.children))for(let f of s.children)u+=o(f);return u};return o(i)}function H(i){let t=function(e){let o=e.split(/([>\s])/).map(r=>r?.trim()).filter(Boolean),s=[],a;for(let r of o){if(r===">"){a=r;continue}let n=a&&a===">"?1:void 0,l={$and:[]},u=r.match(/^([a-zA-Z0-9]+)/),f=[...r.matchAll(/#([a-zA-Z0-9_-]+)/g)],g=[...r.matchAll(/\.([a-zA-Z0-9_-]+)/g)],d=[...r.matchAll(/\[([a-zA-Z0-9_-]+)([*^$]?=["']?([^"']+)["']?)?\]/g)];if(u){let c=u[1];c!=="*"?l.$and.push({tag:c}):l.$and.push({tag:{$regex:c}})}if(f.length>0)for(let c of f)l.$and.push({"attributes.id":{$regex:"(^| )("+c[1]+")( |$)"}});if(g.length>0)for(let c of g)l.$and.push({"attributes.class":{$regex:"(^| )("+c[1]+")( |$)"}});if(d.length>0)for(let c of d){let h=c[1],m=c[2]?c[2][0]:null,w=c[3],$={};m?m==="="?$["attributes."+h]=w:m==="^"?$["attributes."+h]={$regex:`^${w}`}:m==="$"?$["attributes."+h]={$regex:`${w}$`}:m==="*"&&($["attributes."+h]={$regex:w}):$["attributes."+h]={$exists:!0},l.$and.push($)}n?s.push({query:l,depth:n}):s.push({query:l}),a=r}return s};return i.split(",").map(e=>e.trim()).filter(Boolean).map(e=>t(e))}var Ct=class T{constructor(t){this.children=[],typeof t=="string"&&(t=z(t)),Object.assign(this,t),this.children=this.prepare(this.children)}getContent(){let t="";if(typeof this.content=="string")t+=this.content;else for(let e of this.children)t+=e.getContent();return t}setContent(t){return this.children=this.prepare([{content:t}]),this}findOne(t,e=Number.POSITIVE_INFINITY){if(!(e<1))for(let o of this.children){if(D(o,t))return o;let s=o.findOne(t,e-1);if(s)return s}}findMany(t,e=Number.POSITIVE_INFINITY){let o=[];if(e<1)return o;for(let s of this.children){D(s,t)&&o.push(s);let a=s.findMany(t,e-1);o.push(...a)}return o}querySelector(t){let e=H(t);for(let o of e){let s=[this];for(let{query:a,depth:r}of o)s=s.reduce((n,l)=>[...n,...l.findMany(a,r)],[]);if(s[0])return s[0]}}querySelectorAll(t){let e=H(t),o=[];for(let s of e){let a=[this];for(let{query:r,depth:n}of s)a=a.reduce((l,u)=>[...l,...u.findMany(r,n)],[]);o.push(...a)}return o=o.filter((s,a,r)=>r.findIndex(n=>s==n)===a),o}update(t){return ot(this,t),this.children=this.prepare(this.children),this}updateOne(t,e){let o=this.findOne(t);return o&&o.update(e),this}updateMany(t,e){let o=this.findMany(t);for(let s of o)s.update(e);return this}prepare(t){return t.map(e=>{if(e instanceof T)return e.parent=this,e;{let o=new T(e);return o.parent=this,o}})}replace(...t){return this.children=this.prepare(t),this}append(...t){return this.children=this.children.concat(this.prepare(t)),this}prepend(...t){return this.children.splice(0,0,...this.prepare(t)),this}insert(t,...e){return t=Math.floor(Z(t,0,this.children.length)),this.children.splice(t,0,...this.prepare(e)),this}toObject(){let t=N(this);return delete t.parent,t.children=this.children.map(e=>e.toObject()),t}toString(t){return R(this,t)}static{this.parse=z}static{this.stringify=R}};V.use(wt());var _=new xt;_.setCookieSync("over18=yes","https://novel18.syosetu.com/");_.setCookieSync("over18=off","https://syosetu.org/");var bt=$t(fetch,_);async function L(i,t,e=0){let o=0;for(;o<=e;){let s=await i.$(t);if(s)return s;await v(256),o+=256}throw new Error(`Element not found: ${t}`)}async function At(i,t,e=0){let o=await L(i,t,e);return await i.evaluate(a=>a?.textContent,o)}async function U(i,t,e=0){await L(i,t,e),await i.click(t)}async function K(i,t,e,o=0){let s=0;for(;s<=o;){let a=await At(i,t);if(a&&e(a))return a;await v(256),s+=256}throw new Error(`Content not found: ${t}`)}var b=class{constructor(){this.isOpened=!1,this.cacheDir=".puppeteer"}async open(){for(this.isOpened||(this.isOpened=!0,this.browser=await V.launch({headless:!1,userDataDir:this.cacheDir}));!this.browser;)await v(128)}async close(){if(this.isOpened){for(;!this.browser;)await v(128);let t=this.browser;this.browser=void 0,this.isOpened=!1,await t.close()}}async load(t,e,o){if(e||(e=[]),await this.open(),!this.browser)throw new Error("Browser not found");let s=await this.browser.newPage();try{await s.goto(t,this.pageOptions);for(let n of e){let l=setTimeout(()=>{throw new Error(`Element not found: ${n}`)},1e4);await s.waitForSelector(n,{visible:!0,timeout:0}),clearTimeout(l)}o&&await o(s);let a=await s.content(),r=Y.load(a);return await s.close(),r}catch(a){throw await s.close(),a}}async fetch(t,e){let o=await bt(t,e);if(!o.ok)throw new Error("Fetching failed");let s=await o.text();return Y.load(s)}};function J(i){return typeof i=="number"?i:typeof i=="string"?isNaN(parseInt(i))?0:parseInt(i):0}function p(i){return C(i.find("br").replaceWith(`
`).end().text()).trim()}var M=class extends b{constructor(){super()}async getMetadata(t,e){let o=`https://www.alphapolis.co.jp/novel/${t}/${e}`,s=await this.fetch(o),a=s("table.detail"),r=function($){return p(a.find("th").filter(function(){return s(this).text().trim()===$}).next())},n=/連載中/.test(p(s(".content-status.complete"))),l=p(s("h1.title")),u=p(s(".author")),f=p(s(".abstract:nth-child(1)")),g=r("\u521D\u56DE\u516C\u958B\u65E5\u6642").replace(/[^0-9]/g,""),d=r("\u66F4\u65B0\u65E5\u6642").replace(/[^0-9]/g,""),c=g.length===12?Q(g,"YYYYMMDDHHmm").valueOf():0,h=d.length===12?Q(d,"YYYYMMDDHHmm").valueOf():0,m=[];for(let $ of s("div.episode a").toArray()){let P=$.attribs.href,q=P.split("/").pop();if(!q)throw new Error(`ChapterID not found: ${P}`);m.push(q)}return{onGoing:n,title:l,outline:f,author:u,chapterIds:m,createdAt:c,updatedAt:h}}async getChapter(t,e,o,s){let a=`https://www.alphapolis.co.jp/novel/${t}/${e}/episode/${o}`,r=await this.load(a,null,async f=>{let g=0;for(;g<10;){g++;try{await U(f,"#TopLayer",0)}catch{}try{await K(f,"#novelBody",d=>C(d).trim()!=="",1e3);return}catch{}}throw new Error("Content not found")}),n=p(r("div.episode-title")),l=r("#novelBody").find("br").replaceWith(`
`).end().text();return{id:o,seq:s,title:n,content:l}}async getBook(t,e,o){let s=await this.getMetadata(t,e),a=[],r=s.chapterIds.length;for(let l=0;l<r;l++)try{let u=s.chapterIds[l],f=await this.getChapter(t,e,u,l);a.push(f),o&&o(null,f,l,r)}catch(u){o&&o(u,null,l,r)}let n={...s,chapters:a};return await this.close(),n}};import X from"dayjs";var S=class extends b{constructor(){super()}async getMetadata(t){let e=`https://syosetu.org/?mode=ss_detail&nid=${t}`,o=await this.fetch(e),s=function(w){return p(o("td").filter(function(){return o(this).text().trim()===w}).next())},a=/短編|完結/.test(s("\u8A71\u6570")),r=s("\u30BF\u30A4\u30C8\u30EB"),n=s("\u4F5C\u8005"),l=s("\u3042\u3089\u3059\u3058"),u=parseInt(s("\u8A71\u6570").replace(/[^0-9]/g,"")),f=s("\u63B2\u8F09\u958B\u59CB").replace(/[^0-9]/g,""),g=s("\u6700\u65B0\u6295\u7A3F").replace(/[^0-9]/g,""),d=f.length===12?X(f,"YYYYMMDDHHmm").valueOf():0,c=g.length===12?X(g,"YYYYMMDDHHmm").valueOf():0,h=[];for(let w=0;w<u;w++)h.push(""+(w+1));return{onGoing:a,title:r,outline:l,author:n,chapterIds:h,createdAt:d,updatedAt:c}}async getChapter(t,e,o){let s=`https://syosetu.org/novel/${t}/${e}.html`,a=await this.fetch(s),r=p(a("#analytics_start").prev()),n=0,l=a(`#${n}`),u=[];for(;l.length!==0;)u.push(l.text()),n++,l=a(`#${n}`);return{id:e,seq:o,title:r,content:u.join(`
`)}}async getBook(t,e){let o=await this.getMetadata(t),s=[],a=o.chapterIds.length;for(let n=0;n<a;n++)try{let l=o.chapterIds[n],u=await this.getChapter(t,l,n);s.push(u),e&&e(null,u,n,a)}catch(l){e&&e(l,null,n,a)}return{...o,chapters:s}}};import It from"dayjs";var E=class extends b{constructor(){super()}async getMetadata(t){let e=`https://kakuyomu.jp/works/${t}`,o=await this.fetch(e),s=p(o("a[title]").first()),a=p(o(".CollapseTextWithKakuyomuLinks_collapseText__XSlmz")),r=p(o('a[href^="/users"]').first()),n=!1;for(let c of o(".Meta_metaItem__8eZTP").toArray()){let h=o(c).text();if(h.indexOf("\u9023\u8F09\u4E2D")>-1){n=!0;break}else if(h.indexOf("\u5B8C\u7D50\u6E08")>-1){n=!1;break}}let l=0,u=0,f=[],g=JSON.parse(o("#__NEXT_DATA__").text());for(let c of Object.values(g.props.pageProps.__APOLLO_STATE__))if(y(c)&&c.__typename==="Episode"){let h=It(c.publishedAt).valueOf();l?l>h&&(l=h):l=h,u?u<h&&(u=h):u=h,f.push({id:c.id,publishedAt:h})}return f.sort((c,h)=>c.publishedAt-h.publishedAt),{onGoing:n,title:s,outline:a,author:r,chapterIds:f.map(c=>c.id),createdAt:l,updatedAt:u}}async getChapter(t,e,o){let s=`https://kakuyomu.jp/works/${t}/episodes/${e}`,a=await this.fetch(s),r=p(a("#contentMain-header")),n=1,l=a(`#p${n}`),u=[];for(;l.length!==0;)u.push(l.text()),n++,l=a(`#p${n}`);return{id:e,seq:o,title:r,content:u.join(`
`)}}async getBook(t,e){let o=await this.getMetadata(t),s=[],a=o.chapterIds.length;for(let n=0;n<a;n++)try{let l=o.chapterIds[n],u=await this.getChapter(t,l,n);s.push(u),e&&e(null,u,n,a)}catch(l){e&&e(l,null,n,a)}return{...o,chapters:s}}};import tt from"dayjs";var O=class extends b{constructor(){super()}async getMetadata(t){let e=`https://ncode.syosetu.com/novelview/infotop/ncode/${t}/`,o=await this.fetch(e),s=p(o("#noveltype_not"))!=="\u5B8C\u7D50\u6E08",a=p(o("#contents_main > h1 > a")),r=p(o("#noveltable1 tbody tr:nth-child(2) td")),n=p(o("#noveltable1 tbody tr:nth-child(1) td")),l=p(o("#noveltable2 tbody tr:nth-child(1) td")).replace(/[^0-9]/g,""),u=p(o("#noveltable2 tbody tr:nth-child(2) td")).replace(/[^0-9]/g,""),f=l.length===12?tt(l,"YYYYMMDDHHmm").valueOf():0,g=u.length===12?tt(u,"YYYYMMDDHHmm").valueOf():0,d=J(C(o("#pre_info").text()).match(/全([0-9]+)エピソード/)?.[1]||""),c=[];for(let m=0;m<d;m++)c.push(""+(m+1));return{onGoing:s,title:a,outline:n,author:r,chapterIds:c,createdAt:f,updatedAt:g}}async getChapter(t,e,o){let s=`https://ncode.syosetu.com/${t}/${e}`,a=await this.fetch(s),r=p(a("h1.p-novel__title p-novel__title--rensai")),n=1,l=a(`#L${n}`),u=[];for(;l.length!==0;)u.push(l.text()),n++,l=a(`#L${n}`);return{id:e,seq:o,title:r,content:u.join(`
`)}}async getBook(t,e){let o=await this.getMetadata(t),s=[],a=o.chapterIds.length;for(let n=0;n<a;n++)try{let l=o.chapterIds[n],u=await this.getChapter(t,l,n);s.push(u),e&&e(null,u,n,a)}catch(l){e&&e(l,null,n,a)}return{...o,chapters:s}}};async function ae(i,t){if(i==="narou")return await new O().getMetadata(t);if(i==="kakuyomu")return await new E().getMetadata(t);if(i==="alphapolis")return await new M().getMetadata(t.split("/")[0],t.split("/")[1]);if(i==="hameln")return await new S().getMetadata(t);throw new Error(`Invalid type: ${i}`)}async function le(i,t,e){if(i==="narou")return await new O().getBook(t,e);if(i==="kakuyomu")return await new E().getBook(t,e);if(i==="alphapolis")return await new M().getBook(t.split("/")[0],t.split("/")[1],e);if(i==="hameln")return await new S().getBook(t,e);throw new Error(`Invalid type: ${i}`)}export{le as getBook,ae as getMetadata};
