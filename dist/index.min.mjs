import Q from"dayjs";import*as Y from"cheerio";import V from"puppeteer-extra";import yt from"puppeteer-extra-plugin-stealth";import{CookieJar as xt}from"tough-cookie";import $t from"fetch-cookie";function et(o){return typeof o=="boolean"}function C(o){return typeof o=="number"&&!Number.isNaN(o)&&Number.isFinite(o)}function B(o){return typeof o=="string"}function m(o){return typeof o=="object"&&o!==null&&!y(o)}function y(o){return Array&&Array.isArray?Array.isArray(o):Object.prototype.toString.call(o)==="[object Array]"}function rt(o){return typeof o=="function"}function Z(o,t,e){return o-=t,e-=t,o<0&&(o=o%e+e),o>=e&&(o=o%e),o+t}function I(o){return o.replace(/[！-～]/g,function(t){return String.fromCharCode(t.charCodeAt(0)-65248)}).replace(/[^\S\r\n]/g," ")}function nt(o){let t=o.split("/"),e=t.pop(),r=t.slice(1,t.length).join("/");return new RegExp(r,e)}function N(o){let t={};for(let[e,r]of Object.entries(o))m(r)?t[e]=N(r):y(r)?t[e]=G(r):t[e]=r;return t}function D(o,t){function e(s,n){if(m(n)){for(let[a,l]of Object.entries(n))if(!r(s,l,a.split(".")))return!1;return!0}else return i(s,n,"$eq")}function r(s,n,a){let l=a.shift();return a.length>0?m(s)&&B(l)?r(s[l],n,a):!1:B(l)?i(s,n,l):!1}function i(s,n,a){if(a==="$and"){if(!y(n))throw new Error(`Invalid query type: ${typeof n}`);for(let l of n)if(!e(s,l))return!1;return!0}else{if(a==="$nand")return!i(s,n,"$and");if(a==="$or"){if(!y(n))throw new Error(`Invalid query type: ${typeof n}`);for(let l of n)if(e(s,l))return!0;return!1}else{if(a==="$nor")return!i(s,n,"$or");if(a==="$not")return!e(s,n);if(a==="$in"){if(!y(n))throw new Error(`Invalid query type: ${typeof n}`);for(let l of n)if(i(s,l,"$eq"))return!0;return!1}else{if(a==="$nin")return!i(s,n,"$in");if(a==="$gt"){if(!C(n))throw new Error(`Invalid query type: ${typeof n}`);return s>n}else if(a==="$gte"){if(!C(n))throw new Error(`Invalid query type: ${typeof n}`);return s>=n}else if(a==="$lt"){if(!C(n))throw new Error(`Invalid query type: ${typeof n}`);return s<n}else if(a==="$lte"){if(!C(n))throw new Error(`Invalid query type: ${typeof n}`);return s<=n}else if(a==="$eq")if(y(s)&&y(n)){if(s.length!==n.length)return!1;for(let l in n)if(!i(s[l],n[l],"$eq"))return!1;return!0}else return m(n)?e(s,n):s===n;else{if(a==="$ne")return!i(s,n,"$eq");if(a==="$exists"){if(!et(n))throw new Error(`Invalid query type: ${typeof n}`);return s!=null===n}else if(a==="$elemMatch"){if(!m(n))throw new Error(`Invalid query type: ${typeof n}`);if(!y(s))return!1;for(let l of s)if(!e(l,n))return!1;return!0}else if(a==="$mod"){if(!y(n))throw new Error(`Invalid query type: ${typeof n}`);let l=n[0],u=n[1];if(!C(l))throw new Error(`Invalid divisor type: ${typeof l}`);if(!C(u))throw new Error(`Invalid remainder type: ${typeof u}`);return s%l===u}else{if(a==="$size")return y(s)?e(s.length,n):m(s)?e(Object.keys(s).length,n):!1;if(a==="$function"){if(!rt(n))throw new Error(`Invalid query type: ${typeof n}`);return n(s)}else if(a==="$regex"){if(B(n))return n.charAt(0)==="/"?nt(n).test(s):new RegExp(n).test(s);if(n instanceof RegExp)return n.test(s);throw new Error(`Invalid query type: ${typeof n}`)}else if(/^\$-?[0-9]+$/.test(a)){let l=Math.floor(Z(parseInt(a.substring(1)),0,s.length));return e(s[l],n)}else return m(s)?m(n)?e(s[a],n):i(s[a],n,"$eq"):!1}}}}}}return e(o,t)}function ot(o,t){for(let e of Object.keys(t))for(let[r,i]of Object.entries(t[e])){let s=r.split("."),n=s.pop();if(!B(n))continue;let a=o;for(;m(a);){let l=s.shift();if(!l)break;a=a[l]}if(m(a)){if(e==="$set")a[n]=i;else if(e==="$unset")i&&delete a[n];else if(e==="$push")a[n].push(i);else if(e==="$pushAll"){if(Array.isArray(i))for(let l of i)a[n].push(l)}else if(e==="$pull"){for(let l=a[n].length;l>=0;l--)if(a[n][l]===i){a[n].splice(l,1);break}}else if(e==="$pullAll")Array.isArray(i)&&(a[n]=a[n].filter(function(l){for(let u of i)if(l===u)return!1;return!0}));else if(e==="$addToSet"){let l=!1;for(let u of a[n])if(u===i){l=!0;break}l||a[n].push(i)}else if(e==="$addToSetAll"&&Array.isArray(i))for(let l of i){let u=!1;for(let f of a[n])if(f===l){u=!0;break}u||a[n].push(l)}}}return o}function G(o){let t=[];for(let e=0;e<o.length;e++){let r=o[e];m(r)?o[e]=N(r):y(r)?o[e]=G(r):o[e]=r}return t}function O(o){return new Promise(function(t){return setTimeout(t,o)})}var b=[["&","&amp;"],[" ","&nbsp;"],["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&apos;"],["\xA2","&cent;"],["\xA3","&pound;"],["\xA5","&yen;"],["\u20AC","&euro;"],["\xA9","&copy;"],["\xAE","&reg;"]],k=[["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&apos;"]];function it(o){return o.replace(/\r\n/g,`
`)}function at(o){return o.replace(/^</,"").replace(/([^<][!?/])?>$/,"").replace(/\s+/g," ").trim()}function st(o,t){for(let e=o.length-1;e>=0;e--)if(t(o[e],e,o))return e;return-1}function j(o){return encodeURIComponent(o)}function W(o){return decodeURIComponent(o)}function lt(o){for(let t=0;t<b.length;t++)o=o.replace(new RegExp(b[t][0],"g"),b[t][1]);return o}function F(o){for(let t=b.length-1;t>=0;t--)o=o.replace(new RegExp(b[t][1],"g"),b[t][0]);return o}function ut(o){for(let t=0;t<k.length;t++)o=o.replace(new RegExp(k[t][0],"g"),k[t][1]);return o}function ct(o){return o.replace(/<!--([\s\S]*?)-->/g,function(...t){return`<!-->${j(t[1])}</!-->`})}function ft(o){return o.replace(/(<script(?:[\s\S]*?)>)([\s\S]*?)(<\/script>)/g,function(...t){return`${t[1]}${j(t[2])}${t[3]}`})}function ht(o){return o.replace(/(<style(?:[\s\S]*?)>)([\s\S]*?)(<\/style>)/g,function(...t){return`${t[1]}${j(t[2])}${t[3]}`})}function pt(o){return o.replace(/(>)([\s\S]*?)(<)/g,function(...t){return`${t[1]}${lt(t[2])}${t[3]}`})}function gt(o){function t(...e){return`=${j(e[1])} `}return o.replace(/='([^'>]*?)'/g,t).replace(/="([^">]*?)"/g,t)}function dt(o,t){let e=t.split("="),r=e.shift();r&&(e.length===0?o[r]=!0:o[r]=W(e.join("=")))}function mt(o){let t=at(o).split(/\s/),e={tag:t[0]||"",attributes:{},children:[],isClosing:!1,isClosed:!1,isEncoded:!1};typeof e.tag=="string"&&(e.isClosing=/^\//.test(e.tag),e.isClosed=e.isClosing,e.tag=e.tag.replace(/^\//,""),!e.isClosing&&["script","style","!--"].indexOf(e.tag)>-1&&(e.isEncoded=!0));for(let r=1;r<t.length;r++)dt(e.attributes,t[r]);return e}function wt(o){let t="";for(let[e,r]of Object.entries(o))typeof r=="string"?t+=` ${e}="${ut(r)}"`:r===!0&&(t+=` ${e}`);return t}function z(o){o=gt(pt(ht(ft(ct(it(o))))));let t=0,e=/<[^>]*?>/g,r,i=[],s=[],n;for(;r=e.exec(o);){if(t!==r.index){let a=o.substring(t,r.index);i.push({content:F(a)})}if(n=mt(r[0]),!n.isClosing)i.push(n),s.push(n);else{let a=st(i,function(l){return!l.isClosed&&l.tag===n.tag});if(a>-1){let l=i[a];l.isClosed=!0,l.children=i.splice(a+1,i.length-a+1)}}t=e.lastIndex}if(t<o.length){let a=o.substring(t);i.push({content:F(a)})}for(let a of s){if(a.tag&&(a.tag.toUpperCase()==="!DOCTYPE"?a.closer="":a.tag.toLowerCase()==="?xml"?a.closer="?":a.tag==="!--"?a.closer="--":a.isClosed||(a.closer=" /"),a.isEncoded&&a.children))for(let l of a.children)l.content&&(l.content=W(l.content));delete a.isClosed,delete a.isClosing,delete a.isEncoded}return{children:i}}function R(o,t){let e=0,r=function(i){let{tag:s,closer:n,attributes:a,content:l}=t?t(i,e):i,u="";if(e++,typeof s=="string"){if(u+=`<${s}`,typeof a=="object"&&(u+=wt(a)),typeof n!="string"&&(u+=">"),Array.isArray(i.children))for(let f of i.children)u+=r(f);typeof n!="string"?u+=`</${s}>`:u+=`${n}>`}else if(typeof l=="string")u=l;else if(Array.isArray(i.children))for(let f of i.children)u+=r(f);return u};return r(o)}function H(o){let t=function(e){let r=e.split(/([>\s])/).map(n=>n?.trim()).filter(Boolean),i=[],s;for(let n of r){if(n===">"){s=n;continue}let a=s&&s===">"?1:void 0,l={$and:[]},u=n.match(/^([a-zA-Z0-9]+)/),f=[...n.matchAll(/#([a-zA-Z0-9_-]+)/g)],g=[...n.matchAll(/\.([a-zA-Z0-9_-]+)/g)],x=[...n.matchAll(/\[([a-zA-Z0-9_-]+)([*^$]?=["']?([^"']+)["']?)?\]/g)];if(u){let c=u[1];c!=="*"?l.$and.push({tag:c}):l.$and.push({tag:{$regex:c}})}if(f.length>0)for(let c of f)l.$and.push({"attributes.id":{$regex:"(^| )("+c[1]+")( |$)"}});if(g.length>0)for(let c of g)l.$and.push({"attributes.class":{$regex:"(^| )("+c[1]+")( |$)"}});if(x.length>0)for(let c of x){let h=c[1],d=c[2]?c[2][0]:null,w=c[3],$={};d?d==="="?$["attributes."+h]=w:d==="^"?$["attributes."+h]={$regex:`^${w}`}:d==="$"?$["attributes."+h]={$regex:`${w}$`}:d==="*"&&($["attributes."+h]={$regex:w}):$["attributes."+h]={$exists:!0},l.$and.push($)}a?i.push({query:l,depth:a}):i.push({query:l}),s=n}return i};return o.split(",").map(e=>e.trim()).filter(Boolean).map(e=>t(e))}var It=class T{constructor(t){this.children=[],typeof t=="string"&&(t=z(t)),Object.assign(this,t),this.children=this.prepare(this.children)}getContent(){let t="";if(typeof this.content=="string")t+=this.content;else for(let e of this.children)t+=e.getContent();return t}setContent(t){return this.children=this.prepare([{content:t}]),this}findOne(t,e=Number.POSITIVE_INFINITY){if(!(e<1))for(let r of this.children){if(D(r,t))return r;let i=r.findOne(t,e-1);if(i)return i}}findMany(t,e=Number.POSITIVE_INFINITY){let r=[];if(e<1)return r;for(let i of this.children){D(i,t)&&r.push(i);let s=i.findMany(t,e-1);r.push(...s)}return r}querySelector(t){let e=H(t);for(let r of e){let i=[this];for(let{query:s,depth:n}of r)i=i.reduce((a,l)=>[...a,...l.findMany(s,n)],[]);if(i[0])return i[0]}}querySelectorAll(t){let e=H(t),r=[];for(let i of e){let s=[this];for(let{query:n,depth:a}of i)s=s.reduce((l,u)=>[...l,...u.findMany(n,a)],[]);r.push(...s)}return r=r.filter((i,s,n)=>n.findIndex(a=>i==a)===s),r}update(t){return ot(this,t),this.children=this.prepare(this.children),this}updateOne(t,e){let r=this.findOne(t);return r&&r.update(e),this}updateMany(t,e){let r=this.findMany(t);for(let i of r)i.update(e);return this}prepare(t){return t.map(e=>{if(e instanceof T)return e.parent=this,e;{let r=new T(e);return r.parent=this,r}})}replace(...t){return this.children=this.prepare(t),this}append(...t){return this.children=this.children.concat(this.prepare(t)),this}prepend(...t){return this.children.splice(0,0,...this.prepare(t)),this}insert(t,...e){return t=Math.floor(Z(t,0,this.children.length)),this.children.splice(t,0,...this.prepare(e)),this}toObject(){let t=N(this);return delete t.parent,t.children=this.children.map(e=>e.toObject()),t}toString(t){return R(this,t)}static{this.parse=z}static{this.stringify=R}};V.use(yt());var _=new xt;_.setCookieSync("over18=yes","https://novel18.syosetu.com/");_.setCookieSync("over18=off","https://syosetu.org/");var At=$t(fetch,_);async function L(o,t,e=0){let r=0;for(;r<=e;){let i=await o.$(t);if(i)return i;await O(256),r+=256}throw new Error(`Element not found: ${t}`)}async function Ct(o,t,e=0){let r=await L(o,t,e);return await o.evaluate(s=>s?.textContent,r)}async function U(o,t,e=0){await L(o,t,e),await o.click(t)}async function K(o,t,e,r=0){let i=0;for(;i<=r;){let s=await Ct(o,t);if(s&&e(s))return s;await O(256),i+=256}throw new Error(`Content not found: ${t}`)}var A=class{constructor(){this.isOpened=!1,this.cacheDir=".puppeteer"}async open(){for(this.isOpened||(this.isOpened=!0,this.browser=await V.launch({headless:!1,userDataDir:this.cacheDir}));!this.browser;)await O(128)}async close(){if(this.isOpened){for(;!this.browser;)await O(128);let t=this.browser;this.browser=void 0,this.isOpened=!1,await t.close()}}async load(t,e,r){if(e||(e=[]),await this.open(),!this.browser)throw new Error("Browser not found");let i=await this.browser.newPage();try{await i.goto(t,this.pageOptions);for(let a of e){let l=setTimeout(()=>{throw new Error(`Element not found: ${a}`)},1e4);await i.waitForSelector(a,{visible:!0,timeout:0}),clearTimeout(l)}r&&await r(i);let s=await i.content(),n=Y.load(s);return await i.close(),n}catch(s){throw await i.close(),s}}async fetch(t,e){let r=await At(t,e);if(!r.ok)throw new Error("Fetching failed");let i=await r.text();return Y.load(i)}};function J(o){return typeof o=="number"?o:typeof o=="string"?isNaN(parseInt(o))?0:parseInt(o):0}function p(o){return I(o.find("br").replaceWith(`
`).end().text()).trim()}var v=class extends A{constructor(){super()}async getMetadata(t,e){let r=`https://www.alphapolis.co.jp/novel/${t}/${e}`,i=await this.fetch(r),s=i("table.detail"),n=function($){return p(s.find("th").filter(function(){return i(this).text().trim()===$}).next())},a=/連載中/.test(p(i(".content-status.complete"))),l=p(i("h1.title")),u=p(i(".author")),f=p(i(".abstract:nth-child(1)")),g=n("\u521D\u56DE\u516C\u958B\u65E5\u6642").replace(/[^0-9]/g,""),x=n("\u66F4\u65B0\u65E5\u6642").replace(/[^0-9]/g,""),c=g.length===12?Q(g,"YYYYMMDDHHmm").valueOf():0,h=x.length===12?Q(x,"YYYYMMDDHHmm").valueOf():0,d=[];for(let $ of i("div.episode a").toArray()){let P=$.attribs.href,q=P.split("/").pop();if(!q)throw new Error(`ChapterID not found: ${P}`);d.push(q)}return{onGoing:a,title:l,outline:f,author:u,chapterIds:d,createdAt:c,updatedAt:h}}async getChapter(t,e,r){let i=`https://www.alphapolis.co.jp/novel/${t}/${e}/episode/${r}`,s=await this.load(i,null,async u=>{let f=0;for(;f<10;){f++;try{await U(u,"#TopLayer",0)}catch{}try{await K(u,"#novelBody",g=>I(g).trim()!=="",1e3);return}catch{}}throw new Error("Content not found")}),n=p(s("div.episode-title")),a=s("#novelBody").find("br").replaceWith(`
`).end().text();return{id:r,title:n,content:a}}async getBook(t,e,r){let i=await this.getMetadata(t,e),s=[],n=i.chapterIds.length;for(let l=0;l<n;l++)try{let u=i.chapterIds[l],f=await this.getChapter(t,e,u);s.push(f),r&&r(null,f,l,n)}catch(u){r&&r(u,null,l,n)}return{...i,chapters:s}}};import X from"dayjs";var M=class extends A{constructor(){super()}async getMetadata(t){let e=`https://syosetu.org/?mode=ss_detail&nid=${t}`,r=await this.fetch(e),i=function(w){return p(r("td").filter(function(){return r(this).text().trim()===w}).next())},s=/短編|完結/.test(i("\u8A71\u6570")),n=i("\u30BF\u30A4\u30C8\u30EB"),a=i("\u4F5C\u8005"),l=i("\u3042\u3089\u3059\u3058"),u=parseInt(i("\u8A71\u6570").replace(/[^0-9]/g,"")),f=i("\u63B2\u8F09\u958B\u59CB").replace(/[^0-9]/g,""),g=i("\u6700\u65B0\u6295\u7A3F").replace(/[^0-9]/g,""),x=f.length===12?X(f,"YYYYMMDDHHmm").valueOf():0,c=g.length===12?X(g,"YYYYMMDDHHmm").valueOf():0,h=[];for(let w=0;w<u;w++)h.push(""+(w+1));return{onGoing:s,title:n,outline:l,author:a,chapterIds:h,createdAt:x,updatedAt:c}}async getChapter(t,e){let r=`https://syosetu.org/novel/${t}/${e}.html`,i=await this.fetch(r),s=p(i("#analytics_start").prev()),n=0,a=i(`#${n}`),l=[];for(;a.length!==0;)l.push(a.text()),n++,a=i(`#${n}`);return{id:e,title:s,content:l.join(`
`)}}async getBook(t,e){let r=await this.getMetadata(t),i=[],s=r.chapterIds.length;for(let a=0;a<s;a++)try{let l=r.chapterIds[a],u=await this.getChapter(t,l);i.push(u),e&&e(null,u,a,s)}catch(l){e&&e(l,null,a,s)}return{...r,chapters:i}}};import bt from"dayjs";var S=class extends A{constructor(){super()}async getMetadata(t){let e=`https://kakuyomu.jp/works/${t}`,r=await this.fetch(e),i=p(r("a[title]").first()),s=p(r(".CollapseTextWithKakuyomuLinks_collapseText__XSlmz")),n=p(r('a[href^="/users"]').first()),a=!1;for(let c of r(".Meta_metaItem__8eZTP").toArray()){let h=r(c).text();if(h.indexOf("\u9023\u8F09\u4E2D")>-1){a=!0;break}else if(h.indexOf("\u5B8C\u7D50\u6E08")>-1){a=!1;break}}let l=0,u=0,f=[],g=JSON.parse(r("#__NEXT_DATA__").text());for(let c of Object.values(g.props.pageProps.__APOLLO_STATE__))if(m(c)&&c.__typename==="Episode"){let h=bt(c.publishedAt).valueOf();l?l>h&&(l=h):l=h,u?u<h&&(u=h):u=h,f.push({id:c.id,publishedAt:h})}return f.sort((c,h)=>c.publishedAt-h.publishedAt),{onGoing:a,title:i,outline:s,author:n,chapterIds:f.map(c=>c.id),createdAt:l,updatedAt:u}}async getChapter(t,e){let r=`https://kakuyomu.jp/works/${t}/episodes/${e}`,i=await this.fetch(r),s=p(i("#contentMain-header")),n=1,a=i(`#p${n}`),l=[];for(;a.length!==0;)l.push(a.text()),n++,a=i(`#p${n}`);return{id:e,title:s,content:l.join(`
`)}}async getBook(t,e){let r=await this.getMetadata(t),i=[],s=r.chapterIds.length;for(let a=0;a<s;a++)try{let l=r.chapterIds[a],u=await this.getChapter(t,l);i.push(u),e&&e(null,u,a,s)}catch(l){e&&e(l,null,a,s)}return{...r,chapters:i}}};import tt from"dayjs";var E=class extends A{constructor(){super()}async getMetadata(t){let e=`https://ncode.syosetu.com/novelview/infotop/ncode/${t}/`,r=await this.fetch(e),i=p(r("#noveltype_not"))!=="\u5B8C\u7D50\u6E08",s=p(r("#contents_main > h1 > a")),n=p(r("#noveltable1 tbody tr:nth-child(2) td")),a=p(r("#noveltable1 tbody tr:nth-child(1) td")),l=p(r("#noveltable2 tbody tr:nth-child(1) td")).replace(/[^0-9]/g,""),u=p(r("#noveltable2 tbody tr:nth-child(2) td")).replace(/[^0-9]/g,""),f=l.length===12?tt(l,"YYYYMMDDHHmm").valueOf():0,g=u.length===12?tt(u,"YYYYMMDDHHmm").valueOf():0,x=J(I(r("#pre_info").text()).match(/全([0-9]+)エピソード/)?.[1]||""),c=[];for(let d=0;d<x;d++)c.push(""+(d+1));return{onGoing:i,title:s,outline:a,author:n,chapterIds:c,createdAt:f,updatedAt:g}}async getChapter(t,e){let r=`https://ncode.syosetu.com/${t}/${e}`,i=await this.fetch(r),s=p(i("h1.p-novel__title p-novel__title--rensai")),n=1,a=i(`#L${n}`),l=[];for(;a.length!==0;)l.push(a.text()),n++,a=i(`#L${n}`);return{id:e,title:s,content:l.join(`
`)}}async getBook(t,e){let r=await this.getMetadata(t),i=[],s=r.chapterIds.length;for(let a=0;a<s;a++)try{let l=r.chapterIds[a],u=await this.getChapter(t,l);i.push(u),e&&e(null,u,a,s)}catch(l){e&&e(l,null,a,s)}return{...r,chapters:i}}};async function se(o,t){if(o==="narou")return await new E().getMetadata(t);if(o==="kakuyomu")return await new S().getMetadata(t);if(o==="alphapolis")return await new v().getMetadata(t.split("/")[0],t.split("/")[1]);if(o==="hameln")return await new M().getMetadata(t);throw new Error(`Invalid type: ${o}`)}async function le(o,t,e){if(o==="narou")return await new E().getChapter(t,e);if(o==="kakuyomu")return await new S().getChapter(t,e);if(o==="alphapolis"){let r=new v,i=await r.getChapter(t.split("/")[0],t.split("/")[1],e);return await r.close(),i}else{if(o==="hameln")return await new M().getChapter(t,e);throw new Error(`Invalid type: ${o}`)}}async function ue(o,t,e){if(o==="narou")return await new E().getBook(t,e);if(o==="kakuyomu")return await new S().getBook(t,e);if(o==="alphapolis"){let r=new v,i=await r.getBook(t.split("/")[0],t.split("/")[1],e);return await r.close(),i}else{if(o==="hameln")return await new M().getBook(t,e);throw new Error(`Invalid type: ${o}`)}}export{ue as getBook,le as getChapter,se as getMetadata};
